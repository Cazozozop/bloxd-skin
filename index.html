<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Bloxd Skin Editor Simplifi√©</title>
  <style>
    body {
      background: #121212; color: #eee; font-family: monospace;
      display: flex; flex-wrap: wrap; gap: 20px; padding: 20px;
    }
    #viewer { width: 300px; height: 300px; border: 1px solid #444; }
    #texturePreview { image-rendering: pixelated; max-width: 128px; display: none; border: 1px solid #444; }
    textarea { width: 400px; height: 150px; background: #222; color: #0f0; padding: 10px; border: none; }
    button { margin-top: 10px; padding: 10px; cursor: pointer; }
    #status { margin-top: 10px; font-weight: bold; min-height: 1.2em; }
  </style>
</head>
<body>

  <div>
    <h2>üé® Choisir la texture</h2>
    <input type="file" id="textureInput" accept="image/*" />
    <br />
    <img id="texturePreview" />
    <br />
    <button id="uploadBtn" disabled>Upload la texture sur le mod√®le</button>
    <br />
    <button id="downloadZipBtn" disabled>T√©l√©charger le pack ZIP</button>
    <div id="status"></div>
  </div>

  <div>
    <h2>üë§ Pr√©visualisation du skin</h2>
    <div id="viewer"></div>
  </div>
<!-- Place ce code dans le body de ta page -->
<div id="customConsole" style="background:#222; color:#0f0; font-family: monospace; height:200px; overflow-y:auto; padding:10px;"></div>

<script>
  (function() {
    const consoleDiv = document.getElementById('customConsole');
    function logToDiv(...args) {
      const msg = args.map(a => {
        if (typeof a === 'object') return JSON.stringify(a);
        return a;
      }).join(' ');
      consoleDiv.textContent += msg + '\n';
      consoleDiv.scrollTop = consoleDiv.scrollHeight;
    }

    // Override console.log, console.error, etc.
    const originalLog = console.log;
    console.log = function(...args) {
      originalLog.apply(console, args);
      logToDiv(...args);
    };
    const originalError = console.error;
    console.error = function(...args) {
      originalError.apply(console, args);
      logToDiv("ERROR: ", ...args);
    };

    // Tu peux ajouter plus selon besoin (warn, info...)
  })();
</script>

  <div>
    <h2>üìú Code Bloxd (fixe)</h2>
    <textarea readonly>
api.updateEntityNodeMeshAttachment(myId, "ArmRightMesh", "BloxdBlock", {blockName:"INTERNAL_MESH_Blue Balloon", size: 0.382, meshOffset:[0, 0, 0]}, [0, -0.74, 0], [0, 3.145, 0])
api.updateEntityNodeMeshAttachment(myId, "ArmLeftMesh", "BloxdBlock", {blockName:"INTERNAL_MESH_Black Balloon", size: 0.382, meshOffset:[0, 0, 0]}, [0, -0.74, 0], [0, 3.145, 0])
api.updateEntityNodeMeshAttachment(myId, "HeadMesh", "BloxdBlock", {blockName:"INTERNAL_MESH_Brown Balloon", size: 0.5, meshOffset:[0, 0, 0]}, [0, 0.25, 0], [3.14, 0, 0])
api.updateEntityNodeMeshAttachment(myId, "TorsoNode", "BloxdBlock", {blockName:"INTERNAL_MESH_Cyan Balloon", size: 0.38, meshOffset:[0, 0, 0]}, [0, 0, 0], [0, 3.14, 0])
api.updateEntityNodeMeshAttachment(myId, "LegLeftMesh", "BloxdBlock", {blockName:"INTERNAL_MESH_Green Balloon", size: 0.385, meshOffset:[0, 0, 0]}, [0, -0.74, 0], [0, 3.145, 0])
api.updateEntityNodeMeshAttachment(myId, "LegRightMesh", "BloxdBlock", {blockName:"INTERNAL_MESH_Red Balloon", size: 0.385, meshOffset:[0, 0, 0]}, [0, -0.74, 0], [0, 3.145, 0])
    </textarea>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/three@0.160.1/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.160.1/examples/js/loaders/GLTFLoader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

  <script>
    const textureInput = document.getElementById("textureInput");
    const texturePreview = document.getElementById("texturePreview");
    const uploadBtn = document.getElementById("uploadBtn");
    const downloadBtn = document.getElementById("downloadZipBtn");
    const status = document.getElementById("status");

    let textureFile = null;
    let textureURL = null;
    let model = null;
    let skinLoaded = false;

    // Setup three.js scene
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, 1, 0.1, 1000);
    camera.position.z = 2;
    const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
    renderer.setSize(300, 300);
    document.getElementById("viewer").appendChild(renderer.domElement);

    const light = new THREE.AmbientLight(0xffffff, 1);
    scene.add(light);

    function animate() {
      requestAnimationFrame(animate);
      if (model) model.rotation.y += 0.01;
      renderer.render(scene, camera);
    }
    animate();

    textureInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;
      textureFile = file;

      if (textureURL) URL.revokeObjectURL(textureURL);
      textureURL = URL.createObjectURL(file);
      texturePreview.src = textureURL;
      texturePreview.style.display = "block";

      status.textContent = "Texture charg√©e. Clique sur 'Upload'.";
      uploadBtn.disabled = false;
      skinLoaded = false;
      downloadBtn.disabled = true;
    });

    uploadBtn.addEventListener("click", () => {
      if (!textureURL) return;

      status.textContent = "Chargement du skin...";
      uploadBtn.disabled = true;

      const texLoader = new THREE.TextureLoader();
      texLoader.load(textureURL,
        (texture) => {
          texture.magFilter = THREE.NearestFilter;
          texture.minFilter = THREE.NearestFilter;

          const loader = new THREE.GLTFLoader();
          loader.load(
            "https://github.com/Cazozozop/bloxd-skin/raw/main/Skin.gltf",
            (gltf) => {
              gltf.scene.traverse((child) => {
                if (child.isMesh && child.material) {
                  child.material.map = texture;
                  child.material.needsUpdate = true;
                }
              });

              if (model) scene.remove(model);
              model = gltf.scene;
              scene.add(model);

              status.textContent = "Skin charg√© et affich√© !";
              uploadBtn.disabled = false;
              skinLoaded = true;
              downloadBtn.disabled = false;
            },
            undefined,
            (err) => {
              console.error(err);
              status.textContent = "Erreur : impossible de charger le mod√®le.";
              uploadBtn.disabled = false;
            }
          );
        },
        undefined,
        (err) => {
          console.error(err);
          status.textContent = "Erreur : impossible de charger la texture.";
          uploadBtn.disabled = false;
        }
      );
    });

    downloadBtn.addEventListener("click", async () => {
      if (!textureFile || !skinLoaded) {
        alert("Tu dois d'abord charger et uploader une texture.");
        return;
      }

      const zip = new JSZip();
      const files = [
        "Body.glb",
        "Head.glb",
        "Right Arm.glb",
        "Left Arm.glb",
        "Right Leg.glb",
        "Left Leg.glb",
      ];

      status.textContent = "T√©l√©chargement des fichiers...";

      try {
        for (const name of files) {
          const url = `https://github.com/Cazozozop/bloxd-skin/raw/main/${encodeURIComponent(name)}`;
          const res = await fetch(url);
          if (!res.ok) throw new Error("Erreur t√©l√©chargement " + name);
          const blob = await res.blob();
          zip.file(name, blob);
        }
        zip.file("skin.png", textureFile);
        const content = await zip.generateAsync({ type: "blob" });

        const a = document.createElement("a");
        a.href = URL.createObjectURL(content);
        a.download = "bloxd-skin-pack.zip";
        a.click();
        status.textContent = "Pack ZIP pr√™t !";
      } catch (e) {
        console.error(e);
        status.textContent = "Erreur lors du t√©l√©chargement.";
      }
    });
  </script>
</body>
</html>
