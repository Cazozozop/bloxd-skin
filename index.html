<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Bloxd Skin Pack Builder</title>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.0/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <style>
    body { font-family: sans-serif; background: #1e1e1e; color: white; text-align: center; padding: 20px; }
    button, input[type="file"] { margin: 10px; padding: 10px; font-size: 1em; }
    textarea { width: 90%; height: 200px; margin-top: 20px; }
  </style>
</head>
<body>

  <h1>ðŸ’  Bloxd Custom Skin Generator</h1>
  <input type="file" id="textureInput" accept="image/*" />
  <br>
  <button id="generateZip">ðŸ“¦ TÃ©lÃ©charger le pack ZIP</button>
  <button id="copyCode">ðŸ“‹ Copier le code API</button>

  <textarea id="codeOutput" readonly placeholder="Ton code API apparaÃ®tra ici..."></textarea>

  <script type="module">
    import { GLTFLoader } from "https://unpkg.com/three@0.158.0/examples/jsm/loaders/GLTFLoader.js";
    import * as THREE from "https://unpkg.com/three@0.158.0/build/three.module.js";

    const balloonNames = [
      "Blue Balloon",
      "Black Balloon",
      "Brown Balloon",
      "Cyan Balloon",
      "Green Balloon",
      "Red Balloon"
    ];

    const zip = new JSZip();
    const codeOutput = document.getElementById("codeOutput");
    const textureInput = document.getElementById("textureInput");
    let textureDataURL = null;

    textureInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        textureDataURL = reader.result;
        alert("âœ… Texture importÃ©e !");
      };
      reader.readAsDataURL(file);
    });

    async function applyTextureToGLB(url, textureURL) {
      const loader = new GLTFLoader();
      const gltf = await loader.loadAsync(url);
      const texture = await new THREE.TextureLoader().loadAsync(textureURL);
      texture.flipY = false;

      gltf.scene.traverse(child => {
        if (child.isMesh) {
          child.material.map = texture;
          child.material.needsUpdate = true;
        }
      });

      // Export en glb avec texture
      const { GLTFExporter } = await import("https://unpkg.com/three@0.158.0/examples/jsm/exporters/GLTFExporter.js");
      const exporter = new GLTFExporter();
      return new Promise((resolve) => {
        exporter.parse(gltf.scene, (gltfBinary) => {
          resolve(gltfBinary);
        }, { binary: true });
      });
    }

    document.getElementById("generateZip").addEventListener("click", async () => {
      if (!textureDataURL) {
        alert("Importe une texture d'abord !");
        return;
      }

      const modelFolder = zip.folder("models");
      const codeLines = [];

      for (let name of balloonNames) {
        const cleanName = "INTERNAL_MESH_" + name + ".glb";
        const url = `https://github.com/Cazozozop/bloxd-skin/raw/main/${name}.glb`;

        try {
          const glbBinary = await applyTextureToGLB(url, textureDataURL);
          modelFolder.file(cleanName, glbBinary);
          codeLines.push(
            `api.updateEntityNodeMeshAttachment(myId, "${name}", "Custom", {meshName: "${cleanName}", size: 1}, [0,0,0], [0,0,0])`
          );
        } catch (e) {
          console.error("Erreur sur", name, e);
        }
      }

      // Mettre Ã  jour le champ code
      codeOutput.value = codeLines.join("\n");

      // GÃ©nÃ©rer le zip
      const blob = await zip.generateAsync({ type: "blob" });
      saveAs(blob, "Custom Skin.zip");
    });

    document.getElementById("copyCode").addEventListener("click", () => {
      codeOutput.select();
      document.execCommand("copy");
      alert("ðŸ“‹ Code copiÃ© !");
    });
  </script>

</body>
</html>
