<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Bloxd Skin Editor</title>
  <style>
    body {
      font-family: monospace;
      background: #111;
      color: white;
      display: flex;
      gap: 20px;
      padding: 20px;
      flex-wrap: wrap;
    }
    canvas { border: 1px solid #333; }
    .preview { image-rendering: pixelated; max-width: 128px; }
    #buttons button { margin-top: 10px; display: block; }
    textarea { width: 100%; height: 150px; background: #222; color: lime; padding: 10px; }
    #status { margin-top: 10px; font-size: 14px; }
  </style>
</head>
<body>

  <div>
    <h2>üé® Texture</h2>
    <input type="file" id="textureInput" accept="image/*"><br>
    <img id="texturePreview" class="preview" style="display:none;"><br>
    <div id="buttons">
      <button id="uploadBtn" style="display:none;">‚úÖ Upload</button>
      <button id="downloadZipBtn">üì¶ T√©l√©charger ZIP</button>
      <div id="status"></div>
    </div>
  </div>

  <div>
    <h2>üßç‚Äç‚ôÇÔ∏è Skin Preview</h2>
    <div id="viewer" style="width: 300px; height: 300px;"></div>
  </div>

  <div style="flex: 1;">
    <h2>üìú Code Bloxd</h2>
    <textarea readonly>
api.updateEntityNodeMeshAttachment(myId, "ArmRightMesh", "BloxdBlock", {blockName:"INTERNAL_MESH_Blue Balloon", size: 0.382, meshOffset:[0, 0, 0]}, [0, -0.74, 0], [0, 3.145, 0])
api.updateEntityNodeMeshAttachment(myId, "ArmLeftMesh", "BloxdBlock", {blockName:"INTERNAL_MESH_Black Balloon", size: 0.382, meshOffset:[0, 0, 0]}, [0, -0.74, 0], [0, 3.145, 0])
api.updateEntityNodeMeshAttachment(myId, "HeadMesh", "BloxdBlock", {blockName:"INTERNAL_MESH_Brown Balloon", size: 0.5, meshOffset:[0, 0, 0]}, [0, 0.25, 0], [3.14, 0, 0])
api.updateEntityNodeMeshAttachment(myId, "TorsoNode", "BloxdBlock", {blockName:"INTERNAL_MESH_Cyan Balloon", size: 0.38, meshOffset:[0, 0, 0]}, [0, 0, 0], [0, 3.14, 0])
api.updateEntityNodeMeshAttachment(myId, "LegLeftMesh", "BloxdBlock", {blockName:"INTERNAL_MESH_Green Balloon", size: 0.385, meshOffset:[0, 0, 0]}, [0, -0.74, 0], [0, 3.145, 0])
api.updateEntityNodeMeshAttachment(myId, "LegRightMesh", "BloxdBlock", {blockName:"INTERNAL_MESH_Red Balloon", size: 0.385, meshOffset:[0, 0, 0]}, [0, -0.74, 0], [0, 3.145, 0])
    </textarea>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/three@0.160.1/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.160.1/examples/js/loaders/GLTFLoader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script>
    let textureFile, textureURL;
    const textureInput = document.getElementById('textureInput');
    const texturePreview = document.getElementById('texturePreview');
    const uploadBtn = document.getElementById('uploadBtn');
    const viewer = document.getElementById('viewer');
    const status = document.getElementById('status');

    // Setup THREE.js
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, 1, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer();
    renderer.setSize(300, 300);
    viewer.appendChild(renderer.domElement);
    camera.position.z = 2;

    const light = new THREE.AmbientLight(0xffffff, 1);
    scene.add(light);

    let model;

    function animate() {
      requestAnimationFrame(animate);
      if (model) model.rotation.y += 0.01;
      renderer.render(scene, camera);
    }
    animate();

    textureInput.addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;

      textureFile = file;
      textureURL = URL.createObjectURL(file);
      texturePreview.src = textureURL;
      texturePreview.style.display = "block";
      uploadBtn.style.display = "inline-block";
      status.textContent = "";
    });

    uploadBtn.addEventListener('click', () => {
      if (!textureFile) return;

      status.textContent = "‚è≥ Chargement...";
      uploadBtn.disabled = true;

      const loader = new THREE.GLTFLoader();
      const textureLoader = new THREE.TextureLoader();

      textureLoader.load(textureURL, skinTexture => {
        skinTexture.magFilter = THREE.NearestFilter;
        skinTexture.minFilter = THREE.NearestFilter;

        loader.load("https://github.com/Cazozozop/bloxd-skin/raw/main/Skin.gltf", gltf => {
          gltf.scene.traverse(child => {
            if (child.isMesh && child.material) {
              child.material.map = skinTexture;
              child.material.needsUpdate = true;
            }
          });

          if (model) scene.remove(model);
          model = gltf.scene;
          scene.add(model);

          status.textContent = "‚úÖ Skin appliqu√© !";
          uploadBtn.disabled = false;
        }, undefined, err => {
          status.textContent = "‚ùå Erreur de chargement GLTF.";
          uploadBtn.disabled = false;
        });
      }, undefined, err => {
        status.textContent = "‚ùå Erreur de chargement texture.";
        uploadBtn.disabled = false;
      });
    });

    document.getElementById("downloadZipBtn").addEventListener("click", async () => {
      if (!textureFile) return alert("Importe un skin d'abord :)");

      const files = ["Body.glb", "Head.glb", "Right Arm.glb", "Left Arm.glb", "Right Leg.glb", "Left Leg.glb"];
      const zip = new JSZip();

      for (const name of files) {
        const url = `https://github.com/Cazozozop/bloxd-skin/raw/main/${encodeURIComponent(name)}`;
        const blob = await fetch(url).then(res => res.blob());
        zip.file(name, blob);
      }

      zip.file("skin.png", textureFile);

      zip.generateAsync({ type: "blob" }).then(blob => {
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "bloxd-skin-pack.zip";
        link.click();
      });
    });
  </script>
</body>
</html>
